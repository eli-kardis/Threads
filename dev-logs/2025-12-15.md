# 📅 개발일지: 2025-12-15

---

## 1. 📝 기본 정보

| 항목 | 내용 |
|------|------|
| **날짜** | 2025년 12월 15일 (일) |
| **프로젝트** | Threads to Notion Sync (Chrome Extension) |
| **작업 요약** | 동기화 로직 통일, shares 메트릭 추가, 대시보드 6개 통계 UI 구현 및 데이터 불일치 버그 수정 |
| **진행률** | 95% (shares 백필 실행 대기) |

---

## 2. 🗣️ 요구사항 역추적 (Prompt Archive)

### **[요청 1]** "아직도 메인화면에서 동기화 시작 버튼을 누르면 노션에 동기화가 잘 되는데, 여기서 지금 동기화를 누르면 새로운 글이 동기화가 안돼"

* **의도:** 팝업의 "지금 동기화" 버튼이 새 글을 제대로 동기화하지 못하는 문제 해결
* **AI의 해석:** 두 버튼(popup vs options)의 동기화 로직이 다르다는 것을 파악하고, 시간 기반 필터링에서 ID 기반 체크로 통일
* **Gap:** "버그인지, 의도된 차이인지" 명확하지 않았음. Rate limit 최적화 요구도 별도 요청으로 추가됨

### **[요청 2]** "왜 옵션의 버튼과 팝업의 버튼의 동작 차이가 있는거야?"

* **의도:** 동일한 기능인데 왜 다르게 동작하는지 근본 원인 파악
* **AI의 해석:** popup은 `lastSyncTime` 기반, options는 `threadId` 기반으로 필터링하여 불일치 발생
* **Gap:** 처음에 전체 게시글 조회로 잘못 수정했다가 롤백. 요청에 "어떤 방식으로 통일할지" 명시가 없었음

### **[요청 3]** "인사이트 불러올 때 공유수도 불러오게 되어있어?"

* **의도:** Threads API에서 shares(공유) 메트릭을 가져오는지 확인
* **AI의 해석:** 현재 코드에서 shares가 누락되어 있음을 발견하고 추가 제안
* **Gap:** "공유"가 reposts(리포스트)인지 shares(외부 공유)인지 초기 혼동 발생

### **[요청 4]** "대시보드도 바꿔야겠다. 조회수, 좋아요, 댓글, 리포스트만 나와있잖아. 여기에 인용, 공유까지 만들어줘."

* **의도:** 대시보드 통계를 4개에서 6개로 확장하고, 테이블과 참여율 계산에도 반영
* **AI의 해석:** CSS 그리드를 6열로 변경, 박스 크기 축소, 테이블 열 추가, 참여율 공식 수정
* **Gap:** 참여율 가중치(인용 2배, 공유 1.5배)는 별도 질문으로 확인받음

### **[요청 5]** "노션에 저장된 데이터와 대시보드에 있는 데이터가 맞지 않는다고. 뭐가 문제인지 꼼꼼히 찾아봐"

* **의도:** shares가 노션에는 있는데 대시보드에 0으로 표시되는 문제 해결
* **AI의 해석:** 데이터 흐름(API → Storage → UI)을 전체 추적하여 `storage.js`에서 shares 필드 누락 발견
* **Gap:** 문제를 발견하기까지 여러 파일 탐색 필요. 초기 요청에 "shares 관련"이라는 힌트가 있었다면 더 빨랐을 것

---

## 3. 🏗️ 구현 결과물 (Code & Structure)

### **변경된 파일 구조:**
```
src/
├── api/
│   ├── threads.js    # shares 메트릭 추가
│   └── notion.js     # shares 필드 저장/업데이트
├── storage/
│   └── storage.js    # shares 필드 Storage 처리 (핵심 버그 수정)
├── ui/
│   ├── dashboard.html  # 6열 그리드, 인용/공유 카드
│   ├── dashboard.js    # 통계 표시, 참여율 계산
│   ├── options.html    # 필드 매핑 UI
│   └── options.js      # 필드 매핑 로직
└── background.js     # 동기화 로직 통일, 집계 함수
```

### **파일 변경 요약:**

| 파일 경로 | 변경 유형 | 핵심 변경 내용 |
|----------|---------|--------------|
| src/api/threads.js | 수정 | `getThreadInsights`에 `shares` 메트릭 추가 |
| src/api/notion.js | 수정 | `buildProperties`, `updatePageStats`에 shares 필드 처리 |
| src/storage/storage.js | 수정 | `addThreadPageMapping`, `updateThreadInsights`에 shares 추가 **(버그 수정)** |
| src/ui/dashboard.html | 수정 | 6열 CSS 그리드, 인용/공유 통계 카드, 테이블 열 추가 |
| src/ui/dashboard.js | 수정 | `updateStatsCards`, `updateHistoryTable`, `calculateEngagementRate` 수정 |
| src/ui/options.html | 수정 | quotes→인용, shares→공유 필드 매핑 분리 |
| src/ui/options.js | 수정 | `mappingShares` 요소 및 저장 로직 추가 |
| src/background.js | 수정 | `performSync` limit 파라미터, `getAggregatedInsights` shares 합산 |

### **핵심 구현 로직:**

**1. 동기화 로직 통일 (ID 기반 필터링)**
```javascript
// background.js - performSync()
async function performSync(options = {}) {
  const { limit = 30 } = options;
  const response = await threadsApi.getUserThreads(settings.threadsToken, { limit });

  for (const thread of recentThreads) {
    // 시간 기반 → ID 기반으로 변경
    const alreadySynced = await storage.isThreadSynced(thread.id);
    if (alreadySynced) continue;
    // 동기화 진행...
  }
}
```

**2. 참여율 계산 (인용/공유 가중치 적용)**
```javascript
// dashboard.js - calculateEngagementRate()
const engagementCount =
  (insights.likes || 0) +
  (insights.replies || 0) * 2 +      // 댓글: 2배 (직접 참여)
  (insights.reposts || 0) * 1.5 +    // 리포스트: 1.5배
  (insights.quotes || 0) * 2 +       // 인용: 2배 (새 콘텐츠 생성)
  (insights.shares || 0) * 1.5;      // 공유: 1.5배

return (engagementCount / views) * 100;
```

### **적용된 기술/라이브러리:**
- **Threads Graph API**: `views`, `likes`, `replies`, `reposts`, `quotes`, `shares` 메트릭
- **Chrome Extension Storage API**: 로컬 데이터 저장 및 조회
- **CSS Grid**: 6열 반응형 레이아웃 (`repeat(6, 1fr)`)
- **Notion API**: 페이지 생성 및 속성 업데이트

---

## 4. 🐞 에러와 삽질의 기록 (Troubleshooting)

### **[에러 1] 노션-대시보드 데이터 불일치**

* **Error Log:**
```
노션에는 shares가 저장되지만 대시보드에는 항상 0으로 표시됨
```

* **발생 상황:** shares 메트릭을 API와 노션에 추가한 후, 대시보드에서 확인했을 때 발생

* **Root Cause:**
  - **직접 원인:** `storage.js`의 두 함수에서 shares 필드 누락
  - **근본 원인:** 노션은 Threads API 데이터를 직접 저장하지만, 대시보드는 Storage를 통해 데이터를 읽음. **두 경로가 다른 데이터 소스를 사용**하여 불일치 발생

```
데이터 흐름:
[Threads API] → [Notion DB] ✅ shares 저장됨
[Threads API] → [Storage] → [Dashboard] ❌ shares 누락
```

* **Solution:**
```javascript
// Before (storage.js - addThreadPageMapping)
insights: insights || { views: 0, likes: 0, replies: 0, reposts: 0, quotes: 0 }

// After
insights: insights || { views: 0, likes: 0, replies: 0, reposts: 0, quotes: 0, shares: 0 }
```

```javascript
// Before (storage.js - updateThreadInsights)
mappings[index].insights = {
  views: insights.views || 0,
  likes: insights.likes || 0,
  replies: insights.replies || 0,
  reposts: insights.reposts || 0,
  quotes: insights.quotes || 0
};

// After
mappings[index].insights = {
  views: insights.views || 0,
  likes: insights.likes || 0,
  replies: insights.replies || 0,
  reposts: insights.reposts || 0,
  quotes: insights.quotes || 0,
  shares: insights.shares || 0  // ← 핵심 수정
};
```

* **Prevention:**
  > "새 필드를 추가할 때는 **전체 데이터 흐름(API → Storage → UI)**을 체크리스트로 확인하세요. 특히 같은 데이터가 여러 경로로 저장되는 경우, 모든 경로에 필드가 포함되었는지 검증해야 합니다."

---

## 5. 💡 프롬프트 엔지니어링 코칭 (★ Core Feature)

### **😅 내가 했던 요청:**
> "인사이트 불러올 때 공유수도 불러오게 되어있어?"
> "추가해"
> "이제 대시보드도 바꿔야겠다..."
> "노션에 저장된 데이터와 대시보드에 있는 데이터가 맞지 않는다고."

### **✅ 이렇게 했으면 더 좋았다:**
> "Threads API의 **shares** 메트릭을 전체 시스템에 추가해줘.
>
> 1. **API 레이어**: `getThreadInsights`에 shares 추가
> 2. **노션 저장**: 필드 매핑에서 quotes는 '인용', shares는 '공유'로 분리
> 3. **Storage**: `addThreadPageMapping`, `updateThreadInsights`에 shares 포함
> 4. **대시보드**: 6개 통계(조회수, 좋아요, 댓글, 리포스트, 인용, 공유) 한 줄 표시
> 5. **참여율 계산**: 인용 2배, 공유 1.5배 가중치 적용
>
> 노션과 대시보드가 동일한 데이터를 보여주도록 전체 데이터 흐름을 확인해줘."

### **🎓 배움 포인트:**

| 항목 | 문제점 | 개선 방법 |
|------|--------|----------|
| **누락된 정보** | "공유"가 reposts인지 shares인지 불명확 | API 필드명(shares)을 명시적으로 언급 |
| **모호했던 표현** | "대시보드도 바꿔야겠다" | 구체적으로 어떤 UI 요소를 어떻게 변경할지 나열 |
| **개선 핵심** | 단계별 요청 없이 한 번에 큰 변경 요청 | **레이어별 체크리스트** 제공 (API → Storage → UI) |

**핵심 인사이트:**
> 새 필드 추가는 단순해 보이지만, 실제로는 **최소 5개 파일**에 영향을 미칩니다. 처음부터 "전체 데이터 흐름에 추가해줘"라고 요청하면 누락을 방지할 수 있습니다.

---

## 6. 📦 콘텐츠 언번들링 (Unbundling Strategy)

### **(1) 🧵 스레드(Threads)용 마이크로 주제**

**주제 A: "바이브코딩할 때 AI가 놓치는 것"**
* **첫 줄 후킹:** "AI한테 '공유수 추가해'라고 했더니... 노션엔 되는데 대시보드엔 안 됨 😇"
* **시청자 베네핏:** 새 기능 추가 시 체크리스트를 알게 됨 (API → Storage → UI)

**주제 B: "참여율 계산 공식 공개"**
* **첫 줄 후킹:** "좋아요 1개 vs 댓글 1개, 뭐가 더 가치 있을까?"
* **시청자 베네핏:** 콘텐츠 성과 측정에 가중치 개념 적용법

**주제 C: "같은 버튼인데 왜 다르게 작동해?"**
* **첫 줄 후킹:** "코드 복사해서 붙여넣기 했는데 왜 안 돼요? 🤔"
* **시청자 베네핏:** 로직 통일의 중요성, 유지보수 관점 이해

### **(2) 🎬 유튜브 롱폼 아이디어 주제**

**주제 A: "API 데이터가 UI에 안 보일 때 디버깅하는 법"**
* **제목:** "분명히 저장했는데 왜 안 보여요?" | 데이터 흐름 추적 실전 가이드
* **시청자 베네핏:** 백엔드 → 프론트엔드 데이터 흐름 이해, 버그 위치 찾는 체계적 방법

**주제 B: "크롬 확장 프로그램 만들기 #3: 통계 대시보드 구현"**
* **제목:** CSS Grid로 반응형 통계 카드 6개 한 줄에 배치하기
* **시청자 베네핏:** 실제 프로젝트 기반 CSS Grid 활용법

### **(3) 🧩 콘텐츠 소스 매트릭스**

| 카테고리 | 구체적 주제 | 추천 포맷 | 난이도 |
|---------|-----------|----------|-------|
| 에러 해결 | "노션엔 되는데 대시보드엔 안 됨" - 데이터 흐름 불일치 | 카드뉴스/숏폼 | ⭐⭐ |
| 프롬프트 팁 | "새 필드 추가해줘" → 레이어별 체크리스트 요청법 | 스레드 | ⭐ |
| 인사이트 | 참여율 가중치 공식 설계 철학 (댓글 > 좋아요 이유) | 에세이/롱폼 | ⭐⭐⭐ |
| 튜토리얼 | CSS Grid 6열 반응형 레이아웃 | 유튜브 숏폼 | ⭐⭐ |
| 바이브코딩 회고 | "AI가 놓친 한 줄" - storage.js shares 누락 사건 | 스레드 시리즈 | ⭐ |
| API 활용 | Threads API shares 메트릭 사용법 | 블로그/문서 | ⭐⭐ |

---

## 7. 🚀 오늘의 회고 (KPT)

### **Keep** (유지할 점)
- 데이터 불일치 문제를 **전체 데이터 흐름(API → Storage → UI)** 관점에서 분석한 것
- 문제 발견 즉시 근본 원인을 찾아 수정한 것
- 참여율 가중치를 사용자와 논의하여 결정한 것 (인용 2배, 공유 1.5배)

### **Problem** (아쉬운 점)
- "공유"가 reposts인지 shares인지 초기에 혼동하여 시간 소요
- 새 필드 추가 시 Storage 레이어를 처음에 놓침 (노션만 확인하고 넘어감)
- 동기화 로직 통일 시 처음에 잘못된 방향으로 수정했다가 롤백

### **Try** (내일 시도할 것)
- [ ] `REFRESH_STATS` 실행하여 기존 게시글에 shares 데이터 백필
- [ ] 새 필드 추가 시 체크리스트 사용: `[ ] API`, `[ ] Storage`, `[ ] Notion`, `[ ] Dashboard`
- [ ] background.js의 7일 제한 로직 원복 (현재 임시로 모든 게시물로 변경됨)

---

## 8. 📋 내일을 위한 메모

### **미완성 기능:**
- shares 데이터 백필 (기존 148개 게시글)
- background.js `refreshAllPostsStats` 함수 7일 제한 원복

### **이어서 작업할 컨텍스트:**
현재 `refreshAllPostsStats` 함수가 "모든 게시물"을 대상으로 변경된 상태입니다. 백필 완료 후 원래대로 "7일 이내 게시글 + insights 없는 게시글"로 되돌려야 합니다.

### **내일 첫 프롬프트 예시:**
> "REFRESH_STATS로 shares 백필 완료했어. 이제 background.js의 refreshAllPostsStats 함수를 원래대로 돌려줘.
>
> 원래 로직:
> 1. insights 없는 게시글 (백필 대상)
> 2. 게시일 기준 7일 이내 게시글 (정기 새로고침)
>
> 합쳐서 중복 제거 후 업데이트하는 방식이었어."

---

*✨ Generated by Claude Code | 바이브코딩 회고 파트너*
